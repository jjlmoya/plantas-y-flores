---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PageHeader from '../../components/PageHeader.vue';
import HorizontalPlantScroll from '../../components/HorizontalPlantScroll.vue';
import DynamicCategoryContent from '../../components/DynamicCategoryContent.vue';
import { generateCategoryPaths, getPlantsByCategory } from '../../utils/data.js';

export async function getStaticPaths() {
  const categoryPaths = await generateCategoryPaths();
  
  const paths = [];
  
  for (const categoryPath of categoryPaths) {
    const categoryPlants = await getPlantsByCategory(categoryPath.props.categorySlug);
    
    // Solo generar página de categoría si tiene plantas (variedades)
    paths.push({
      params: categoryPath.params,
      props: {
        category: categoryPath.props.category,
        plants: categoryPlants.map(plant => ({
          id: plant.data.id,
          slug: plant.slug,
          title: plant.data.title,
          excerpt: plant.data.excerpt,
          date: plant.data.date,
          featured_image: plant.data.featured_image,
          main_image: plant.data.main_image,
          categories: plant.data.categories
        }))
      }
    });
  
  }
  
  return paths;
}

const { category, plants } = Astro.props;
const sortedPlants = plants.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

const title = `${category.name} - Plantas y Flores`;
const description = `Descubre todo sobre ${category.name.toLowerCase()}. Guías completas de cultivo, cuidados y consejos para ${category.name.toLowerCase()}.${category.posts_count > 0 ? ` ${category.posts_count} artículos disponibles.` : ''}`;

const breadcrumbs = [
  { text: 'Inicio', href: '/' },
  { text: 'Categorías', href: '/categorias/' },
  { text: category.name, href: `/${Astro.params.category}/` }
];

const stats = category.posts_count > 0 ? {
  number: category.posts_count,
  label: category.posts_count === 1 ? 'variedad disponible' : 'variedades disponibles'
} : null;
---

<BaseLayout 
  title={title}
  description={description}
  image={category.main_image}
  canonical={`https://plantasyflores.online/${Astro.params.category}/`}
>
  <!-- Breadcrumbs Schema para categorías -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Inicio",
        "item": "https://plantasyflores.online/"
      },
      {
        "@type": "ListItem",
        "position": 2,
        "name": "Categorías",
        "item": "https://plantasyflores.online/categorias/"
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": category.name,
        "item": `https://plantasyflores.online/${Astro.params.category}/`
      }
    ]
  })}></script>
  <PageHeader 
    client:load
    title={category.name}
    description={category.description}
    breadcrumbs={breadcrumbs}
    stats={stats}
  />

  <div class="category-page">

    <!-- Plants Scroll -->
    {sortedPlants.length > 0 ? (
      <section class="plants-section">
        <div class="section-header">
          <h2 class="section-title">Explora todas las variedades</h2>
          <p class="section-subtitle">Descubre cada tipo de {category.name.toLowerCase()} disponible</p>
        </div>
        <HorizontalPlantScroll 
          client:load
          plants={sortedPlants}
        />
      </section>
    ) : (
      <div></div>
    )}

    <!-- Category Content -->
    {category.content && (
      <section class="category-main-content">
        <div class="content-header">
          <h2 class="content-title">Guía completa de {category.name}</h2>
          <div class="content-divider"></div>
        </div>
        <DynamicCategoryContent 
          client:load
          content={category.content}
          plants={sortedPlants}
        />
      </section>
    )}
  </div>
</BaseLayout>

<style>
.category-page {
  max-width: none;
  padding: 0;
}

/* Página de categoría individual */

/* Sección de plantas */
.plants-section {
  margin: 3rem 0;
}

.section-header {
  text-align: center;
  margin-bottom: 2rem;
}

.section-title {
  font-size: 2rem;
  font-weight: 700;
  color: #2d3748;
  margin: 0 0 0.5rem 0;
}

.section-subtitle {
  font-size: 1.1rem;
  color: #64748b;
  margin: 0;
}

/* Sección sin plantas mejorada */
.no-plants-section {
  margin: 4rem 0;
}

.no-plants {
  text-align: center;
  padding: 4rem 2rem;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  border-radius: 24px;
  border: 1px solid #e2e8f0;
}

.no-plants-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
}

.no-plants h3 {
  font-size: 1.5rem;
  color: #2d3748;
  margin: 0 0 1rem 0;
  font-weight: 600;
}

.no-plants p {
  font-size: 1.1rem;
  color: #64748b;
  margin: 0 0 2rem 0;
}

.back-home {
  display: inline-block;
  background: #4a7c23;
  color: white;
  padding: 1rem 2rem;
  border-radius: 12px;
  text-decoration: none;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
}

.back-home:hover {
  background: #2d5016;
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(74, 124, 35, 0.3);
}

/* Contenido principal */
.category-main-content {
  margin-top: 4rem;
}

.content-header {
  text-align: center;
  margin-bottom: 3rem;
}

.content-title {
  font-size: 2.2rem;
  font-weight: 700;
  color: #2d3748;
  margin: 0 0 1rem 0;
}

.content-divider {
  width: 80px;
  height: 4px;
  background: linear-gradient(135deg, #4a7c23 0%, #2d5016 100%);
  border-radius: 2px;
  margin: 0 auto;
}

/* Responsive para el contenido de la página */
@media (max-width: 768px) {
  
  .section-title {
    font-size: 1.6rem;
  }
  
  .content-title {
    font-size: 1.8rem;
  }
}

@media (max-width: 480px) {
  .category-header {
    padding: 1.5rem 1rem 2.5rem 1rem;
    margin: -1.5rem -1rem 1.5rem -1rem;
  }
  
  .category-header__title {
    font-size: 1.8rem;
  }
  
  .breadcrumb {
    margin-bottom: 1.5rem;
  }
  
  .no-plants {
    padding: 3rem 1.5rem;
  }
  
  .no-plants-icon {
    font-size: 3rem;
  }
}
</style>