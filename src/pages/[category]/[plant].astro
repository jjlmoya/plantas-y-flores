---
import BaseLayout from '../../layouts/BaseLayout.astro';
import RelatedPlants from '../../components/RelatedPlants.vue';
import CalendarLinkCard from '../../components/CalendarLinkCard.vue';
import ArticleContent from '../../components/ads/ArticleContent.vue';
import SidebarRectangle from '../../components/ads/SidebarRectangle.vue';
import FavoriteButton from '../../components/FavoriteButton.vue';
import { generatePlantPaths, getPlants } from '../../utils/data.js';
import { getAvailableCalendarCategories } from '../../utils/calendar-inheritance.js';

export async function getStaticPaths() {
  return await generatePlantPaths();
}

const { plant } = Astro.props;
const allPlants = await getPlants();

// Preparar datos para RelatedPlants
const currentPlantData = {
  slug: plant.slug,
  title: plant.data.title,
  categories: plant.data.categories,
  tags: plant.data.tags || []
};

const allPlantsData = allPlants.map(p => ({
  slug: p.slug,
  title: p.data.title,
  excerpt: p.data.excerpt,
  categories: p.data.categories,
  tags: p.data.tags || [],
  main_image: p.data.main_image,
  featured_image: p.data.featured_image
}));

const category = plant.data.categories[0];
const title = `${plant.data.title} - ${category?.name || 'Plantas'} - Plantas y Flores`;
const description = plant.data.excerpt.replace(/<[^>]*>/g, '').substring(0, 160) + '...';

// Check if this plant has a calendar available
const availableCalendarCategories = await getAvailableCalendarCategories();
const categorySlug = category?.slug?.toLowerCase();
const hasCalendar = categorySlug && availableCalendarCategories.includes(categorySlug);
const getImagePath = (imageUrl) => {
  if (!imageUrl) return null;
  
  // Si ya es una ruta local, devolverla tal como está
  if (imageUrl.startsWith('/wp-content/uploads/')) {
    return imageUrl;
  }
  
  // Convertir URLs de WordPress a rutas locales
  if (imageUrl.includes('plantasyflores.online/wp-content/uploads/')) {
    return imageUrl.replace(/https?:\/\/[^/]*\/wp-content\/uploads\//, '/wp-content/uploads/');
  }
  
  // Si no es una URL de WordPress, devolver tal como está
  return imageUrl;
};

const imageUrl = getImagePath(plant.data.main_image || plant.data.featured_image);

const formatDate = (dateString) => {
  return new Date(dateString).toLocaleDateString('es-ES', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

// Schema.org estructurado
const currentYear = new Date().getFullYear();
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": plant.data.title,
  "description": description,
  "image": imageUrl ? `https://plantasyflores.online${imageUrl}` : null,
  "datePublished": plant.data.date,
  "dateModified": plant.data.date,
  "author": {
    "@type": "Organization",
    "name": "Plantas y Flores"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Plantas y Flores",
    "logo": {
      "@type": "ImageObject",
      "url": "https://plantasyflores.online/logo.webp"
    }
  },
  "mainEntity": {
    "@type": "Plant",
    "name": plant.data.title,
    "description": description,
    ...(hasCalendar && {
      "additionalProperty": [
        {
          "@type": "PropertyValue",
          "name": "Calendario de Cultivo",
          "value": `${currentYear}`,
          "url": `https://plantasyflores.online/calendario/${categorySlug}/${plant.slug}/`
        }
      ]
    })
  },
  ...(hasCalendar && {
    "relatedLink": [
      {
        "@type": "Link",
        "url": `https://plantasyflores.online/calendario/${categorySlug}/${plant.slug}/`,
        "name": `Calendario de cultivo ${plant.data.title} ${currentYear}`,
        "description": `Fechas exactas para sembrar, trasplantar y cosechar ${plant.data.title} en España`
      }
    ]
  }),
  "keywords": `${plant.data.title}, cultivo, calendario, siembra, trasplante, cosecha, ${currentYear}, España, jardinería, ${category?.name || 'plantas'}`
};
---

<BaseLayout 
  title={title}
  description={description}
  image={imageUrl ? `https://plantasyflores.online${imageUrl}` : null}
  canonical={`https://plantasyflores.online/${category?.slug || 'plantas'}/${plant.slug}/`}
>
  <!-- Schema.org estructurado -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)}></script>
  
  <!-- Breadcrumbs Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
      {
        "@type": "ListItem",
        "position": 1,
        "name": "Inicio",
        "item": "https://plantasyflores.online/"
      },
      {
        "@type": "ListItem", 
        "position": 2,
        "name": category?.name || "Plantas",
        "item": `https://plantasyflores.online/${category?.slug || 'plantas'}/`
      },
      {
        "@type": "ListItem",
        "position": 3,
        "name": plant.data.title,
        "item": `https://plantasyflores.online/${category?.slug || 'plantas'}/${plant.slug}/`
      }
    ]
  })}></script>
  
  <article class="plant-article">
    <!-- Article Header -->
    <header class="plant-article__header">
      <nav class="breadcrumb">
        <a href="/">Inicio</a>
        <span class="breadcrumb__separator">›</span>
        <a href={`/${category?.slug || 'plantas'}/`}>{category?.name || 'Plantas'}</a>
        <span class="breadcrumb__separator">›</span>
        <span class="breadcrumb__current">{plant.data.title}</span>
      </nav>
      
      <div class="plant-article__title-wrapper" data-plant-slug={plant.slug}>
        <h1 class="plant-article__title">{plant.data.title}</h1>
        <FavoriteButton client:load plantSlug={plant.slug} large={true} />
      </div>
      
      <div class="plant-article__meta">
        <time datetime={plant.data.date} class="plant-article__date">
          {formatDate(plant.data.date)}
        </time>
        
        <div class="plant-article__categories">
          {plant.data.categories.map(cat => (
            <a href={`/${cat.slug}/`} class="plant-article__category">
              {cat.name}
            </a>
          ))}
        </div>
      </div>
    </header>

    <!-- Calendar Link Card -->
    {hasCalendar && (
      <CalendarLinkCard 
        client:visible
        plantName={plant.data.title}
        categorySlug={categorySlug}
        plantSlug={plant.slug}
      />
    )}

    <!-- Featured Image -->
    {imageUrl && (
      <div class="plant-article__image">
        <img 
          src={imageUrl} 
          alt={plant.data.title}
          width="800"
          height="500"
          loading="eager"
          fetchpriority="high"
          class="plant-article__featured-image"
        />
      </div>
    )}

    <!-- Article Content -->
    <div class="plant-article__content">
      <div class="content-with-ads" set:html={plant.data.seo_html}></div>
    </div>

    <!-- Tags -->
    {plant.data.tags && plant.data.tags.length > 0 && (
      <footer class="plant-article__footer">
        <div class="plant-article__tags">
          <span class="plant-article__tags-label">Etiquetas:</span>
          {plant.data.tags.map(tag => (
            <span class="plant-article__tag">{tag.name}</span>
          ))}
        </div>
      </footer>
    )}

    <!-- Related Plants -->
    <RelatedPlants 
      client:visible
      currentPlant={currentPlantData}
      allPlants={allPlantsData}
      maxResults={6}
    />

    <!-- Navigation -->
    <div class="plant-article__navigation">
      <a href={`/${category?.slug || 'plantas'}/`} class="plant-article__back">
        ← Volver a {category?.name || 'Plantas'}
      </a>
    </div>
  </article>

  <!-- Script para insertar anuncios en el contenido -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const content = document.querySelector('.content-with-ads');
      if (!content) return;

      const paragraphs = content.querySelectorAll('p');
      const headings = content.querySelectorAll('h2, h3');
      
      // Insertar anuncio después del segundo párrafo o primera sección si existe
      let insertPoint = null;
      
      if (paragraphs.length >= 3) {
        insertPoint = paragraphs[2];
      } else if (headings.length > 0) {
        // Buscar el primer h2 o h3 y insertar después
        insertPoint = headings[0].nextElementSibling;
      }
      
      if (insertPoint && insertPoint.tagName === 'P') {
        // Crear el contenedor del anuncio
        const adContainer = document.createElement('div');
        adContainer.className = 'content-ad-container';
        adContainer.innerHTML = `
          <div class="content-ad-wrapper">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-1623099484223246"
                 data-ad-slot="6785803497"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
        `;
        
        // Insertar después del párrafo objetivo
        insertPoint.parentNode.insertBefore(adContainer, insertPoint.nextSibling);
        
        // Activar AdSense
        if (window.adsbygoogle) {
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        }
      }

      // Insertar sidebar ad después de la mitad del contenido
      const allElements = content.children;
      const middleIndex = Math.floor(allElements.length / 2);
      
      if (allElements.length > 4 && middleIndex > 2) {
        const sidebarAdContainer = document.createElement('div');
        sidebarAdContainer.className = 'sidebar-ad-container';
        sidebarAdContainer.innerHTML = `
          <div class="sidebar-ad-wrapper">
            <ins class="adsbygoogle"
                 style="display:inline-block;width:320px;height:250px"
                 data-ad-client="ca-pub-1623099484223246"
                 data-ad-slot="8980721998"></ins>
          </div>
        `;
        
        const targetElement = allElements[middleIndex];
        targetElement.parentNode.insertBefore(sidebarAdContainer, targetElement);
        
        // Activar AdSense
        if (window.adsbygoogle) {
          (window.adsbygoogle = window.adsbygoogle || []).push({});
        }
      }
    });
  </script>
</BaseLayout>

<style is:inline>
/* Estilos críticos para above the fold */
.plant-article {
  max-width: 850px;
  margin: 0 auto;
  position: relative;
}

.plant-article__header {
  margin-bottom: 2rem;
}

.plant-article__title {
  font-size: clamp(2rem, 5vw, 3rem);
  font-weight: 700;
  color: #1a5511;
  margin: 0 0 2rem 0;
  line-height: 1.2;
  letter-spacing: -0.02em;
  text-shadow: 0 2px 4px rgba(26, 85, 17, 0.1);
}

.breadcrumb {
  margin-bottom: 1.5rem;
  font-size: 0.875rem;
  color: #666;
}

.breadcrumb a {
  color: #4a7c23;
  text-decoration: none;
}

.plant-article__image {
  margin: 3rem 0;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
}

.plant-article__featured-image {
  width: 100%;
  height: auto;
  display: block;
  object-fit: cover;
  max-height: 500px;
}
</style>

<style>

/* Estilos para anuncios intercalados en el contenido */
.content-ad-container {
  margin: 2.5rem 0;
  text-align: center;
  padding: 1.5rem 0;
  border-top: 1px solid #e0e0e0;
  border-bottom: 1px solid #e0e0e0;
  background: linear-gradient(135deg, #f8fffe 0%, #f0f8f0 100%);
}

.content-ad-wrapper {
  max-width: 100%;
  margin: 0 auto;
}

.sidebar-ad-container {
  margin: 3rem 0;
  text-align: center;
  padding: 2rem 1rem;
  background: #f9f9f9;
  border-radius: 12px;
  border: 1px solid #e0e0e0;
}

.sidebar-ad-wrapper {
  display: inline-block;
  max-width: 100%;
}

@media (max-width: 768px) {
  .content-ad-container {
    margin: 2rem 0;
    padding: 1rem 0;
  }
  
  .sidebar-ad-container {
    margin: 2rem 0;
    padding: 1.5rem 1rem;
  }
  
  .sidebar-ad-wrapper .adsbygoogle {
    width: 100% !important;
    height: auto !important;
  }
}

.plant-article__header {
  margin-bottom: 2rem;
}

.breadcrumb {
  margin-bottom: 1.5rem;
  font-size: 0.875rem;
  color: #666;
}

.breadcrumb a {
  color: #4a7c23;
  text-decoration: none;
  transition: color 0.3s ease;
}

.breadcrumb a:hover {
  color: #2d5016;
}

.breadcrumb__separator {
  margin: 0 0.5rem;
}

.breadcrumb__current {
  color: #999;
}

.plant-article__title-wrapper {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 2rem;
  position: relative;
}

.plant-article__title {
  font-size: clamp(2rem, 5vw, 3rem);
  font-weight: 700;
  color: #1a5511;
  margin: 0;
  line-height: 1.2;
  letter-spacing: -0.02em;
  text-shadow: 0 2px 4px rgba(26, 85, 17, 0.1);
  flex: 1;
}

.plant-article__meta {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  flex-wrap: wrap;
  padding-bottom: 1.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.plant-article__date {
  color: #666;
  font-size: 0.875rem;
}

.plant-article__categories {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.plant-article__category {
  background: #e8f5e8;
  color: #2d5016;
  padding: 0.25rem 0.75rem;
  border-radius: 16px;
  text-decoration: none;
  font-size: 0.75rem;
  font-weight: 600;
  transition: background-color 0.3s ease;
}

.plant-article__category:hover {
  background: #d1e7dd;
}

.plant-article__image {
  margin: 3rem 0;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
  position: relative;
  background: linear-gradient(45deg, #f8f9fa, #e9ecef);
}

.plant-article__featured-image {
  width: 100%;
  height: auto;
  display: block;
  object-fit: cover;
  max-height: 500px;
  transition: transform 0.3s ease;
}

.plant-article__image:hover .plant-article__featured-image {
  transform: scale(1.02);
}

.plant-article__content {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 3.5rem 3rem;
  border-radius: 24px;
  box-shadow: 0 1px 6px rgba(0, 0, 0, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.2);
  margin: 3rem 0;
  line-height: 1.8;
  font-size: clamp(1rem, 2.5vw, 1.125rem);
  position: relative;
}

.plant-article__content :global(h1),
.plant-article__content :global(h2),
.plant-article__content :global(h3),
.plant-article__content :global(h4),
.plant-article__content :global(h5),
.plant-article__content :global(h6) {
  color: #2d5016;
  margin: 2rem 0 1rem 0;
  font-weight: 700;
}

.plant-article__content :global(h2) {
  font-size: clamp(1.5rem, 3vw, 2rem);
  border-bottom: 3px solid #dcfce7;
  padding-bottom: 0.8rem;
  margin-top: 3rem;
  position: relative;
}

.plant-article__content :global(h2):first-child {
  margin-top: 0;
}

.plant-article__content :global(h3) {
  font-size: clamp(1.25rem, 2.5vw, 1.6rem);
  margin-top: 2.5rem;
  color: #166534;
}

.plant-article__content :global(p) {
  margin: 0 0 1.5rem 0;
  text-align: justify;
  hyphens: auto;
}

.plant-article__content :global(ul),
.plant-article__content :global(ol) {
  margin: 0 0 1.25rem 0;
  padding-left: 1.5rem;
}

.plant-article__content :global(li) {
  margin-bottom: 0.5rem;
}

.plant-article__content :global(a) {
  color: #4a7c23;
  text-decoration: underline;
  transition: color 0.3s ease;
}

.plant-article__content :global(a:hover) {
  color: #2d5016;
}

.plant-article__content :global(img) {
  max-width: 100%;
  height: auto;
  border-radius: 16px;
  margin: 2rem auto;
  display: block;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.plant-article__content :global(img):hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
}

.plant-article__content :global(blockquote) {
  background: linear-gradient(135deg, #f0fdf4, #ecfdf5);
  border-left: 5px solid #22c55e;
  margin: 2rem 0;
  padding: 1.5rem 2rem;
  border-radius: 0 16px 16px 0;
  font-style: italic;
  position: relative;
  box-shadow: 0 4px 16px rgba(34, 197, 94, 0.1);
}

.plant-article__footer {
  background: white;
  padding: 1.5rem 2.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  margin: 2rem 0;
}

.plant-article__tags {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.plant-article__tags-label {
  font-weight: 600;
  color: #2d5016;
}

.plant-article__tag {
  background: #f0f8f0;
  color: #4a7c23;
  padding: 0.25rem 0.75rem;
  border-radius: 16px;
  font-size: 0.75rem;
  font-weight: 500;
}

.plant-article__navigation {
  margin: 3rem 0 2rem 0;
  text-align: center;
}

.plant-article__back {
  display: inline-block;
  background: #4a7c23;
  color: white;
  padding: 1rem 2rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: background-color 0.3s ease;
}

.plant-article__back:hover {
  background: #2d5016;
}

@media (max-width: 768px) {
  .plant-article__image {
    margin: 2rem 0;
    border-radius: 16px;
  }
  
  .plant-article__content {
    padding: 2.5rem 2rem;
    margin: 2rem 0;
    border-radius: 20px;
  }
  
  .plant-article__meta {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .plant-article__content :global(h2) {
    margin-top: 2rem;
    padding-bottom: 0.6rem;
  }
  
  .plant-article__content :global(img) {
    margin: 1.5rem auto;
    border-radius: 12px;
  }
  
  .plant-article__content :global(blockquote) {
    margin: 1.5rem 0;
    padding: 1.2rem 1.5rem;
    border-radius: 0 12px 12px 0;
  }
}

@media (max-width: 480px) {
  .plant-article__image {
    margin: 1.5rem 0;
    border-radius: 12px;
  }
  
  .plant-article__content {
    padding: 2rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 16px;
  }
  
  .breadcrumb {
    font-size: 0.8rem;
  }
  
  .plant-article__content :global(h2) {
    margin-top: 1.5rem;
  }
  
  .plant-article__content :global(h3) {
    margin-top: 1.2rem;
  }
  
  .plant-article__content :global(p) {
    text-align: left;
    margin-bottom: 1.2rem;
  }
  
  .plant-article__content :global(blockquote) {
    margin: 1rem 0;
    padding: 1rem 1.2rem;
    border-radius: 0 8px 8px 0;
    font-size: 0.95rem;
  }
}
</style>