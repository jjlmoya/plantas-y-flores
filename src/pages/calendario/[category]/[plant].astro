---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import HeaderExport from '../../../components/HeaderExport.vue';
import ScovilleCard from '../../../components/ScovilleCard.vue';
import { getPlantCalendarWithUI, getGlobalCalendarConfig, getUIHelpers, generatePlantPaths, getOriginFlag, getAvailableCalendarCategories } from '../../../utils/calendar-inheritance.js';

// Generate static paths for all plants
export async function getStaticPaths() {
  try {
    const plantPaths = await generatePlantPaths();
    
    const result = plantPaths.map(({ params, props }) => ({
      params: { 
        category: params.category,
        plant: params.plant
      },
      props
    }));
    
    return result;
  } catch (error) {
    console.error('Error in getStaticPaths for plants:', error);
    return [];
  }
}

const { category, plant: plantSlug } = Astro.params;

if (!category || !plantSlug) {
  return Astro.redirect('/calendario/');
}

// Get plant calendar data with UI helpers
const plantCalendar = await getPlantCalendarWithUI(category, plantSlug);
const globalConfig = await getGlobalCalendarConfig();
const ui = getUIHelpers(globalConfig);
const availableCategories = await getAvailableCalendarCategories();

if (!plantCalendar || !plantCalendar._inheritance.has_plant_specific && !plantCalendar._inheritance.has_category) {
  return Astro.redirect('/calendario/');
}

const categoryName = ui.formatCategoryName(category);
const plantIndividualName = ui.formatPlantName(plantSlug);
const plantName = `${categoryName} ${plantIndividualName}`;
const categoryIcon = ui.getCategoryIcon(category);

// Process calendar data for timeline view
const timelineData = [];

// Generate 12-month timeline
for (let month = 1; month <= 12; month++) {
  const monthData = {
    month,
    monthName: ui.getMonthName(month),
    activities: []
  };

  const calendar = plantCalendar.calendar_data || {};

  // Check sowing activities
  if (calendar.sowing) {
    if (calendar.sowing.indoor?.best_months?.includes(month)) {
      monthData.activities.push({
        type: 'sowing',
        subtype: 'indoor',
        label: 'Siembra Interior',
        color: ui.getActivityColor('sowing'),
        icon: ui.getTaskIcon('prepare_seedbeds'),
        details: calendar.sowing.indoor.temperature_range ? 
          `${calendar.sowing.indoor.temperature_range[0]}-${calendar.sowing.indoor.temperature_range[1]}°C` : null
      });
    }
    
    if (calendar.sowing.outdoor?.best_months?.includes(month)) {
      monthData.activities.push({
        type: 'sowing',
        subtype: 'outdoor',
        label: 'Siembra Exterior',
        color: ui.getActivityColor('sowing'),
        icon: ui.getTaskIcon('prepare_seedbeds'),
        details: calendar.sowing.outdoor.temperature_range ? 
          `${calendar.sowing.outdoor.temperature_range[0]}-${calendar.sowing.outdoor.temperature_range[1]}°C` : null
      });
    }
  }

  // Check transplanting
  if (calendar.transplanting?.best_months?.includes(month)) {
    monthData.activities.push({
      type: 'transplanting',
      label: 'Trasplante',
      color: ui.getActivityColor('transplanting'),
      icon: ui.getTaskIcon('transplant'),
      details: calendar.transplanting.soil_temperature_min ? 
        `Suelo min: ${calendar.transplanting.soil_temperature_min}°C` : null
    });
  }

  // Check harvesting
  if (calendar.harvesting?.best_months?.includes(month)) {
    const isPeak = calendar.harvesting.peak_months?.includes(month);
    monthData.activities.push({
      type: 'harvesting',
      label: isPeak ? 'Cosecha Principal' : 'Cosecha',
      color: ui.getActivityColor('harvesting'),
      icon: ui.getTaskIcon(isPeak ? 'harvest_main' : 'harvest_early'),
      priority: isPeak ? 'high' : 'medium',
      details: calendar.harvesting.days_to_harvest ? 
        `${calendar.harvesting.days_to_harvest[0]}-${calendar.harvesting.days_to_harvest[1]} días` : null
    });
  }

  // Check flowering (for perennials)
  if (calendar.flowering?.best_months?.includes(month)) {
    const isPeak = calendar.flowering.peak_months?.includes(month);
    monthData.activities.push({
      type: 'flowering',
      label: isPeak ? 'Floración Principal' : 'Floración',
      color: ui.getActivityColor('flowering'),
      icon: ui.getTaskIcon('enjoy_blooms'),
      priority: isPeak ? 'high' : 'medium'
    });
  }

  // Check planting (for perennials)
  if (calendar.planting?.best_months?.includes(month)) {
    monthData.activities.push({
      type: 'planting',
      label: 'Plantación',
      color: ui.getActivityColor('planting'),
      icon: ui.getTaskIcon('prepare_beds')
    });
  }

  // Check monthly tasks (avoid duplicating planting, sowing if already added)
  const monthlyTasks = calendar.care_calendar?.monthly_tasks?.[month.toString()];
  if (monthlyTasks && monthlyTasks.length > 0) {
    // Get already added activity types and subtypes to avoid duplicates
    const existingTypes = monthData.activities.map(a => a.type);
    const existingSubtypes = monthData.activities.map(a => a.subtype).filter(Boolean);
    
    monthlyTasks.forEach(task => {
      // Skip planting task if we already added a planting activity
      if (task === 'planting' && existingTypes.includes('planting')) {
        return;
      }
      
      // Skip sowing tasks if we already added the specific sowing type
      if ((task === 'sowing_indoor' || task === 'sow_indoor') && existingSubtypes.includes('indoor')) {
        return;
      }
      if ((task === 'sowing_outdoor' || task === 'sow_outdoor') && existingSubtypes.includes('outdoor')) {
        return;
      }
      
      // Skip general sowing if we already have any sowing activity
      if (task === 'sowing' && existingTypes.includes('sowing')) {
        return;
      }
      
      // Skip harvesting tasks if we already have general harvesting
      if ((task === 'harvest_winter' || task === 'harvest_summer' || task === 'harvest_early') && existingTypes.includes('harvesting')) {
        return;
      }
      
      // Skip transplanting task if we already added a transplanting activity
      if (task === 'transplant' && existingTypes.includes('transplanting')) {
        return;
      }
      
      // Skip planting tasks if we already have sowing (they're similar)
      if (task === 'planting' && existingTypes.includes('sowing')) {
        return;
      }
      
      monthData.activities.push({
        type: 'care',
        label: ui.formatTaskName(task),
        color: ui.getActivityColor('care'),
        icon: ui.getTaskIcon(task),
        priority: ui.getTaskPriority(task)
      });
    });
  }

  timelineData.push(monthData);
}

// Group plant info
const plantInfo = {
  scientific_name: plantCalendar.plant_info?.scientific_name,
  common_names: plantCalendar.plant_info?.common_names,
  origin: plantCalendar.plant_info?.origin,
  type: plantCalendar.plant_info?.type,
  difficulty: plantCalendar.plant_info?.difficulty,
  family: plantCalendar.plant_info?.family
};

const growingConditions = plantCalendar.growing_conditions || {};
const harvestData = plantCalendar.harvest_data || {};
const nutritionalData = plantCalendar.nutritional_data || {};
const flowerData = plantCalendar.flower_data || {};
const scovilleData = plantCalendar.scoville_data || null;

// Article link
const articleLink = plantCalendar._article_links?.resolved_link;

// Translate companion plant names from English to Spanish and check if they have categories
function translateAndCheckCompanionPlants(companions) {
  const translations = {
    'muscari': 'Muscari',
    'narcisos': 'Narcisos', 
    'crocus': 'Crocus',
    'daffodils': 'Narcisos',
    'snowdrops': 'Campanillas de Invierno',
    'allium': 'Allium',
    'hyacinth': 'Jacinto',
    'iris': 'Iris',
    'fritillaria': 'Fritilaria',
    'scilla': 'Escila',
    'chionodoxa': 'Gloria de las Nieves',
    'galanthus': 'Campanilla de Invierno',
    'narcissus': 'Narciso',
    'basil': 'albahaca',
    'tomato': 'tomate',
    'rose': 'rosa',
    'lavender': 'lavanda',
    'thyme': 'tomillo',
    'chamomile': 'manzanilla',
    'strawberry': 'fresa',
    'chilli': 'chili',
    'potato': 'patata',
    'cabbage': 'col',
    'orchid': 'orquidea',
    'tulip': 'tulipan',
    'hibiscus': 'hibiscus',
    'lily': 'lirios',
    'mango': 'mango',
    'banana': 'plátano',
    'pineapple': 'piña',
    // Traducciones faltantes para companions
    'cotton': 'algodón',
    'maize': 'maíz',
    'corn': 'maíz', 
    'legumes': 'leguminosas',
    'rosemary': 'romero',
    'sage': 'salvia',
    'onion': 'cebolla',
    'garlic': 'ajo',
    'celery': 'apio',
    'parsley': 'perejil',
    'oregano': 'orégano',
    'mint': 'menta',
    'dill': 'eneldo',
    'chives': 'cebollino',
    'walnut': 'nogal',
    'fennel': 'hinojo',
    'borage': 'borraja',
    'marigold': 'caléndula',
    'petunia': 'petunia',
    'nasturtium': 'capuchina'
  };
  
  if (!companions || !Array.isArray(companions)) return [];
  
  return companions.map(companion => {
    const translatedName = translations[companion.toLowerCase()] || companion;
    const categoryExists = availableCategories.includes(translatedName.toLowerCase());
    
    return {
      originalName: companion,
      translatedName: translatedName,
      hasCategory: categoryExists,
      categorySlug: categoryExists ? translatedName.toLowerCase() : null
    };
  });
}

const processedCompanions = translateAndCheckCompanionPlants(growingConditions.companion_plants);
const processedAvoidPlants = translateAndCheckCompanionPlants(growingConditions.avoid_plants);

// Generate dynamic Schema FAQ based on plant data
function generateSchemaFAQ() {
  const faq = [];
  const calendar = plantCalendar.calendar_data || {};

  // Sowing question
  if (calendar.sowing) {
    const sowingMonths = [];
    if (calendar.sowing.indoor?.best_months) {
      sowingMonths.push(...calendar.sowing.indoor.best_months);
    }
    if (calendar.sowing.outdoor?.best_months) {
      sowingMonths.push(...calendar.sowing.outdoor.best_months);
    }
    
    if (sowingMonths.length > 0) {
      const uniqueMonths = [...new Set(sowingMonths)].sort();
      const monthNames = uniqueMonths.map(m => ui.getMonthName(m));
      const tempInfo = calendar.sowing.indoor?.temperature_range || calendar.sowing.outdoor?.temperature_range;
      
      let answer = `${plantName} se siembra `;
      if (monthNames.length <= 2) {
        answer += `en ${monthNames.join(' y ')}`;
      } else {
        answer += `desde ${monthNames[0]} hasta ${monthNames[monthNames.length - 1]}`;
      }
      
      if (tempInfo) {
        answer += `, con temperatura óptima entre ${tempInfo[0]}-${tempInfo[1]}°C`;
      }
      
      if (calendar.sowing.indoor?.best_months && calendar.sowing.outdoor?.best_months) {
        answer += '. Se puede sembrar en interior y trasplantar después, o directamente en exterior según el clima.';
      }
      
      faq.push({
        question: `¿Cuándo sembrar ${plantName}?`,
        answer: answer
      });
    }
  }

  // Transplanting question
  if (calendar.transplanting?.best_months) {
    const transplantMonths = calendar.transplanting.best_months.map(m => ui.getMonthName(m));
    let answer = `El trasplante de ${plantName} se realiza `;
    if (transplantMonths.length <= 2) {
      answer += `en ${transplantMonths.join(' y ')}`;
    } else {
      answer += `desde ${transplantMonths[0]} hasta ${transplantMonths[transplantMonths.length - 1]}`;
    }
    
    if (calendar.transplanting.soil_temperature_min) {
      answer += `, cuando el suelo alcance al menos ${calendar.transplanting.soil_temperature_min}°C`;
    }
    
    answer += '. Es importante esperar a que las plántulas tengan el tamaño adecuado y hayan pasado las últimas heladas.';
    
    faq.push({
      question: `¿Cuándo trasplantar ${plantName}?`,
      answer: answer
    });
  }

  // Harvesting question
  if (calendar.harvesting?.best_months) {
    const harvestMonths = calendar.harvesting.best_months.map(m => ui.getMonthName(m));
    let answer = `La cosecha de ${plantName} se realiza `;
    if (harvestMonths.length <= 2) {
      answer += `en ${harvestMonths.join(' y ')}`;
    } else {
      answer += `desde ${harvestMonths[0]} hasta ${harvestMonths[harvestMonths.length - 1]}`;
    }
    
    if (calendar.harvesting.days_to_harvest) {
      const days = calendar.harvesting.days_to_harvest;
      answer += `, aproximadamente entre ${days[0]}-${days[1]} días después de la siembra`;
    }
    
    if (harvestData.harvest_indicators?.length > 0) {
      const indicators = harvestData.harvest_indicators.map(ind => ui.formatTaskName(ind));
      answer += `. Indicadores de cosecha: ${indicators.join(', ')}.`;
    }
    
    faq.push({
      question: `¿Cuándo cosechar ${plantName}?`,
      answer: answer
    });
  }

  // Care/maintenance question if monthly tasks exist
  const hasCareTasks = Object.values(calendar.care_calendar?.monthly_tasks || {}).some(tasks => tasks.length > 0);
  if (hasCareTasks) {
    let answer = `${plantName} requiere cuidados específicos según la época: `;
    
    const careByMonth = Object.entries(calendar.care_calendar?.monthly_tasks || {})
      .filter(([_, tasks]) => tasks.length > 0)
      .map(([month, tasks]) => ({
        month: ui.getMonthName(parseInt(month)),
        tasks: tasks.map(task => ui.formatTaskName(task)).join(', ')
      }));
    
    if (careByMonth.length > 0) {
      answer += careByMonth.slice(0, 3).map(care => 
        `${care.month}: ${care.tasks}`
      ).join('; ');
      
      if (careByMonth.length > 3) {
        answer += '. Otros cuidados varían según el mes específico.';
      }
    }
    
    faq.push({
      question: `¿Qué cuidados necesita ${plantName}?`,
      answer: answer
    });
  }

  return faq;
}

const schemaFAQ = generateSchemaFAQ();

// Prepare export data
const plantExportData = {
  plantName,
  timelineData
};
---

<BaseLayout 
  title={`Calendario de cultivo del ${plantName.toLowerCase()} ${new Date().getFullYear()}: siembra, trasplante y cosecha`}
  description={`🌱 Guía completa de cultivo para ${plantName}. Calendario detallado con fechas de siembra, trasplante y cosecha. ${plantInfo.scientific_name ? `${plantInfo.scientific_name}. ` : ''}Aprende cuándo y cómo cultivar ${plantName} paso a paso.`}
  keywords={`${plantName}, cultivo ${plantName}, calendario ${plantName}, plantar ${plantName}, sembrar ${plantName}, ${plantInfo.scientific_name || ''}, ${categoryName}`}
  type="article"
  canonical={`https://plantasyflores.online/calendario/${category}/${plantSlug}/`}
  category={categoryName}
  publishedDate={new Date().toISOString()}
  modifiedDate={new Date().toISOString()}
  noAds={true}
>
  <link rel="stylesheet" href="/styles/calendar-theme.css">
  
  <div class="plant-calendar-view">
    <!-- Header -->
    <header class="page-header">
      <div class="container">
        <div class="breadcrumb">
          <a href="/">🏠 Inicio</a>
          <span class="separator">→</span>
          <a href="/calendario/">📅 Calendario</a>
          <span class="separator">→</span>
          <a href={`/calendario/categoria/${category}/`}>
            <span class="category-icon-small">{categoryIcon}</span>
            {categoryName}
          </a>
          <span class="separator">→</span>
          <span class="current">
            <span class="plant-icon-small">{categoryIcon}</span>
            {plantIndividualName}
          </span>
        </div>

        <div class="plant-title">
          <h1 class="page-title">
            <span class="plant-icon">{categoryIcon}</span>
            Calendario de {plantName}
          </h1>
          {plantInfo.scientific_name && (
            <p class="scientific-name">{plantInfo.scientific_name}</p>
          )}
          
          <HeaderExport 
            client:load
            exportData={plantExportData}
            exportType="plant"
            title={`Calendario ${plantName}`}
          />
          
          <div class="plant-meta">
            {plantInfo.type && (
              <span class={`plant-type ${plantInfo.type}`}>
                {ui.formatTaskName(plantInfo.type)}
              </span>
            )}
            {plantInfo.difficulty && (
              <span class={`difficulty ${plantInfo.difficulty}`}>
                {ui.formatTaskName(plantInfo.difficulty)}
              </span>
            )}
            {plantInfo.origin && (
              <span class="origin">
                {getOriginFlag(plantInfo.origin)}
              </span>
            )}
          </div>

          {articleLink && (
            <div class="article-link-section">
              <a href={articleLink} class="main-article-btn">
                📖 Ver Artículo Completo
              </a>
            </div>
          )}
        </div>
      </div>
    </header>

    <div class="container">
      
      <!-- Introduction Section -->
      <section class="intro-section">
        <div class="intro-content">
          <p>
            Esta <strong>guía completa de cultivo de {plantName}</strong> te ayuda a planificar la <em>siembra</em>, 
            <em>trasplante</em> y <em>cosecha</em> mes a mes. Este calendario agrícola incluye las mejores fechas 
            para cultivar, cuidados específicos y consejos de jardinería orgánica adaptados a tu zona climática 
            y condiciones locales.
          </p>
          <p>
            <strong>Cómo usar este calendario:</strong> Las actividades mostradas están organizadas por meses, 
            indicando cuándo sembrar, trasplantar y cosechar. Los iconos de color indican la prioridad 
            de cada tarea, y las temperaturas ayudan a determinar el momento exacto según tu zona.
          </p>
        </div>
      </section>

      <!-- Timeline Section -->
      <section class="timeline-section">
        <h2>📅 Calendario Anual de {plantName}</h2>
        
        <!-- Mobile Timeline -->
        <div class="timeline-mobile">
          {timelineData.map(monthData => (
            <div 
              class={`timeline-month-mobile ${monthData.activities.length > 0 ? 'has-activities' : ''}`}
              key={`mobile-${monthData.month}`}
            >
              <div class="timeline-month-header-mobile">
                <div class="timeline-month-name-mobile">{monthData.monthName}</div>
                <div class="timeline-month-number-mobile">{monthData.month}</div>
              </div>
              
              {monthData.activities.length > 0 ? (
                <div class="timeline-activities-mobile">
                  {monthData.activities.map((activity, index) => (
                    <div 
                      class={`timeline-activity-mobile ${activity.type} ${activity.priority || 'normal'}`}
                      key={`mobile-${index}`}
                    >
                      <div class="timeline-activity-icon-mobile">
                        {activity.icon}
                      </div>
                      <div class="timeline-activity-content-mobile">
                        <div class="timeline-activity-label-mobile">{activity.label}</div>
                        {activity.details && (
                          <div class="timeline-activity-details-mobile">
                            {activity.details}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div class="timeline-no-activities-mobile">
                  Mantenimiento general
                </div>
              )}
            </div>
          ))}
        </div>

        <!-- Desktop Timeline -->
        <div class="timeline-desktop">
          <div class="yearly-timeline">
            <div class="timeline-months">
              {timelineData.map(monthData => (
                <div 
                  class={`timeline-month ${monthData.activities.length > 0 ? 'has-activities' : ''}`}
                  key={monthData.month}
                >
                  <div class="month-header">
                    <h3>{monthData.monthName}</h3>
                    <span class="month-number">{monthData.month}</span>
                  </div>
                  
                  <div class="month-activities">
                    {monthData.activities.length > 0 ? (
                      <div class="activities-list">
                        {monthData.activities.map((activity, index) => (
                          <div 
                            class={`activity-item ${activity.priority || 'normal'}`}
                            key={index}
                            style={`border-left-color: ${activity.color}`}
                          >
                            <div class="activity-header">
                              <span class="activity-icon">{activity.icon}</span>
                              <span class="activity-label">{activity.label}</span>
                            </div>
                            {activity.details && (
                              <div class="activity-details">
                                {activity.details}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    ) : (
                      <div class="no-activities">
                        <span>Mantenimiento general</span>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>

      <!-- Scoville Information (for chili plants) -->
      {scovilleData && (
        <ScovilleCard 
          client:visible
          scovilleData={scovilleData}
        />
      )}

      <!-- Plant Details Grid -->
      <div class="details-grid">
        <!-- Growing Conditions -->
        <section class="details-card">
          <h3>🌱 Condiciones de Cultivo</h3>
          <div class="conditions-grid">
            {growingConditions.sun_requirements && (
              <div class="condition-item">
                <span class="condition-icon">☀️</span>
                <div>
                  <strong>Luz</strong>
                  <p>{ui.formatTaskName(growingConditions.sun_requirements)}</p>
                </div>
              </div>
            )}

            {growingConditions.water_needs && (
              <div class="condition-item">
                <span class="condition-icon">💧</span>
                <div>
                  <strong>Agua</strong>
                  <p>{ui.formatTaskName(growingConditions.water_needs)}</p>
                </div>
              </div>
            )}

            {growingConditions.soil_type && (
              <div class="condition-item">
                <span class="condition-icon">🌍</span>
                <div>
                  <strong>Suelo</strong>
                  <p>{ui.formatTaskName(growingConditions.soil_type)}</p>
                </div>
              </div>
            )}

            {growingConditions.soil_ph && (
              <div class="condition-item">
                <span class="condition-icon">⚗️</span>
                <div>
                  <strong>pH</strong>
                  <p>{growingConditions.soil_ph[0]} - {growingConditions.soil_ph[1]}</p>
                </div>
              </div>
            )}

            {growingConditions.spacing && (
              <div class="condition-item">
                <span class="condition-icon">📏</span>
                <div>
                  <strong>Espaciado</strong>
                  <p>{growingConditions.spacing.plant_distance}cm entre plantas</p>
                </div>
              </div>
            )}
          </div>
        </section>

        <!-- Harvest Information -->
        {(harvestData.storage_life || harvestData.weight_range || harvestData.preservation_methods) && (
          <section class="details-card">
            <h3>🌾 Información de Cosecha</h3>
            <div class="harvest-info">
              {harvestData.storage_life && (
                <div class="harvest-item">
                  <span class="harvest-icon">📦</span>
                  <div>
                    <strong>Conservación</strong>
                    <p>{harvestData.storage_life} días</p>
                  </div>
                </div>
              )}

              {harvestData.weight_range && (
                <div class="harvest-item">
                  <span class="harvest-icon">⚖️</span>
                  <div>
                    <strong>Peso</strong>
                    <p>{harvestData.weight_range[0]}-{harvestData.weight_range[1]}g</p>
                  </div>
                </div>
              )}

              {harvestData.preservation_methods && (
                <div class="harvest-item">
                  <span class="harvest-icon">🥫</span>
                  <div>
                    <strong>Conservación</strong>
                    <p>{harvestData.preservation_methods.map(method => ui.formatTaskName(method)).join(', ')}</p>
                  </div>
                </div>
              )}
            </div>
          </section>
        )}

        <!-- Companion Plants -->
        {(processedCompanions.length > 0 || processedAvoidPlants.length > 0) && (
          <section class="details-card">
            <h3>🤝 Plantas Compañeras</h3>
            
            {processedCompanions.length > 0 && (
              <div class="companions-section">
                <h4 class="companions-title good">✅ Buenas Compañeras</h4>
                <div class="companions-list">
                  {processedCompanions.map(companion => {
                    const CompanionElement = companion.hasCategory ? 'a' : 'span';
                    return (
                      <CompanionElement 
                        href={companion.hasCategory ? `/calendario/categoria/${companion.categorySlug}/` : undefined}
                        class={`companion-tag good ${companion.hasCategory ? 'clickable' : 'no-link'}`}
                        key={companion.originalName}
                        title={companion.hasCategory ? `Ver calendario de ${companion.translatedName}` : `${companion.translatedName} (no disponible)`}
                      >
                        <span class="companion-icon">{ui.getCategoryIcon(companion.categorySlug || 'default')}</span>
                        {companion.translatedName}
                        {!companion.hasCategory && <span class="no-link-indicator">*</span>}
                      </CompanionElement>
                    );
                  })}
                </div>
                {processedCompanions.some(c => !c.hasCategory) && (
                  <p class="companions-note">* Estas plantas no tienen guía de cultivo disponible</p>
                )}
              </div>
            )}

            {processedAvoidPlants.length > 0 && (
              <div class="companions-section">
                <h4 class="companions-title bad">❌ Evitar Plantar Cerca</h4>
                <div class="companions-list">
                  {processedAvoidPlants.map(avoid => {
                    const AvoidElement = avoid.hasCategory ? 'a' : 'span';
                    return (
                      <AvoidElement
                        href={avoid.hasCategory ? `/calendario/categoria/${avoid.categorySlug}/` : undefined}
                        class={`companion-tag bad ${avoid.hasCategory ? 'clickable' : 'no-link'}`}
                        key={avoid.originalName}
                        title={avoid.hasCategory ? `Ver calendario de ${avoid.translatedName}` : `${avoid.translatedName} (no disponible)`}
                      >
                        <span class="companion-icon">{ui.getCategoryIcon(avoid.categorySlug || 'default')}</span>
                        {avoid.translatedName}
                        {!avoid.hasCategory && <span class="no-link-indicator">*</span>}
                      </AvoidElement>
                    );
                  })}
                </div>
                {processedAvoidPlants.some(a => !a.hasCategory) && (
                  <p class="companions-note">* Estas plantas no tienen guía de cultivo disponible</p>
                )}
              </div>
            )}
          </section>
        )}

        <!-- Plant Details -->
        <section class="details-card">
          <h3>🌿 Información de la Planta</h3>
          <div class="plant-details-grid">
            {plantInfo.family && (
              <div class="plant-detail-item">
                <span class="detail-icon">🏛️</span>
                <div>
                  <strong>Familia</strong>
                  <p>{plantInfo.family}</p>
                </div>
              </div>
            )}

            {plantInfo.type && (
              <div class="plant-detail-item">
                <span class="detail-icon">🔄</span>
                <div>
                  <strong>Tipo</strong>
                  <p>{ui.formatTaskName(plantInfo.type)}</p>
                </div>
              </div>
            )}

            {plantInfo.difficulty && (
              <div class="plant-detail-item">
                <span class="detail-icon">{plantInfo.difficulty === 'easy' ? '😊' : plantInfo.difficulty === 'intermediate' ? '🤔' : '😰'}</span>
                <div>
                  <strong>Dificultad</strong>
                  <p>{ui.formatTaskName(plantInfo.difficulty)}</p>
                </div>
              </div>
            )}

            {plantInfo.origin && (
              <div class="plant-detail-item">
                <span class="detail-icon">{getOriginFlag(plantInfo.origin)}</span>
                <div>
                  <strong>Origen</strong>
                  <p>{ui.formatOriginName(plantInfo.origin)}</p>
                </div>
              </div>
            )}

            {plantInfo.common_names && plantInfo.common_names.length > 0 && (
              <div class="plant-detail-item">
                <span class="detail-icon">📝</span>
                <div>
                  <strong>Otros Nombres</strong>
                  <p>{plantInfo.common_names.join(', ')}</p>
                </div>
              </div>
            )}

            {growingConditions.special_care && (
              <div class="plant-detail-item special-care">
                <span class="detail-icon">⚠️</span>
                <div>
                  <strong>Cuidados Especiales</strong>
                  <p>{growingConditions.special_care}</p>
                </div>
              </div>
            )}
          </div>
        </section>

        <!-- Flower Data (for flowering plants) -->
        {Object.keys(flowerData).length > 0 && (
          <section class="details-card">
            <h3>🌸 Características de la Flor</h3>
            <div class="flower-details-grid">
              {flowerData.colors && flowerData.colors.length > 0 && (
                <div class="flower-detail-item">
                  <span class="detail-icon">🎨</span>
                  <div>
                    <strong>Colores</strong>
                    <p>{flowerData.colors.map(color => ui.formatTaskName(color)).join(', ')}</p>
                  </div>
                </div>
              )}

              {flowerData.fragrance && (
                <div class="flower-detail-item">
                  <span class="detail-icon">👃</span>
                  <div>
                    <strong>Fragancia</strong>
                    <p>{ui.formatTaskName(flowerData.fragrance)}</p>
                  </div>
                </div>
              )}

              {flowerData.size && (
                <div class="flower-detail-item">
                  <span class="detail-icon">📏</span>
                  <div>
                    <strong>Tamaño</strong>
                    <p>{ui.formatTaskName(flowerData.size)}</p>
                  </div>
                </div>
              )}

              {flowerData.flower_shape && (
                <div class="flower-detail-item">
                  <span class="detail-icon">⭕</span>
                  <div>
                    <strong>Forma</strong>
                    <p>{ui.formatTaskName(flowerData.flower_shape)}</p>
                  </div>
                </div>
              )}

              {flowerData.bloom_duration && (
                <div class="flower-detail-item">
                  <span class="detail-icon">⏰</span>
                  <div>
                    <strong>Duración de Floración</strong>
                    <p>{ui.formatTaskName(flowerData.bloom_duration)}</p>
                  </div>
                </div>
              )}
            </div>
          </section>
        )}

        <!-- Nutritional Data (for edible plants) -->
        {Object.keys(nutritionalData).length > 0 && (
          <section class="details-card">
            <h3>🍎 Información Nutricional</h3>
            <div class="nutrition-details-grid">
              {nutritionalData.calories_per_100g && (
                <div class="nutrition-item">
                  <span class="nutrition-icon">⚡</span>
                  <div>
                    <strong>Calorías</strong>
                    <p>{nutritionalData.calories_per_100g} kcal/100g</p>
                  </div>
                </div>
              )}

              {nutritionalData.main_nutrients && nutritionalData.main_nutrients.length > 0 && (
                <div class="nutrition-item">
                  <span class="nutrition-icon">🧬</span>
                  <div>
                    <strong>Nutrientes Principales</strong>
                    <p>{nutritionalData.main_nutrients.map(nutrient => ui.formatTaskName(nutrient)).join(', ')}</p>
                  </div>
                </div>
              )}

              {nutritionalData.vitamin_content && nutritionalData.vitamin_content.length > 0 && (
                <div class="nutrition-item">
                  <span class="nutrition-icon">💊</span>
                  <div>
                    <strong>Vitaminas</strong>
                    <p>{nutritionalData.vitamin_content.join(', ')}</p>
                  </div>
                </div>
              )}

              {nutritionalData.health_benefits && nutritionalData.health_benefits.length > 0 && (
                <div class="nutrition-item">
                  <span class="nutrition-icon">💪</span>
                  <div>
                    <strong>Beneficios</strong>
                    <p>{nutritionalData.health_benefits.map(benefit => ui.formatTaskName(benefit)).join(', ')}</p>
                  </div>
                </div>
              )}
            </div>
          </section>
        )}

        <!-- Additional Harvest Information -->
        {(harvestData.harvest_indicators || harvestData.yield_per_plant || harvestData.best_harvest_time || harvestData.post_harvest_care || harvestData.fiber_yield || harvestData.seed_yield || harvestData.uses || harvestData.fiber_quality) && (
          <section class="details-card">
            <h3>📈 Detalles de Cosecha</h3>
            <div class="harvest-details-grid">
              {harvestData.harvest_indicators && harvestData.harvest_indicators.length > 0 && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">🎯</span>
                  <div>
                    <strong>Indicadores de Cosecha</strong>
                    <p>{harvestData.harvest_indicators.map(indicator => ui.formatTaskName(indicator)).join(', ')}</p>
                  </div>
                </div>
              )}

              {harvestData.yield_per_plant && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">🌾</span>
                  <div>
                    <strong>Rendimiento por Planta</strong>
                    <p>{harvestData.yield_per_plant}</p>
                  </div>
                </div>
              )}

              {harvestData.best_harvest_time && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">🕐</span>
                  <div>
                    <strong>Mejor Hora de Cosecha</strong>
                    <p>{ui.formatTaskName(harvestData.best_harvest_time)}</p>
                  </div>
                </div>
              )}

              {harvestData.post_harvest_care && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">🧼</span>
                  <div>
                    <strong>Cuidado Post-Cosecha</strong>
                    <p>{ui.formatTaskName(harvestData.post_harvest_care)}</p>
                  </div>
                </div>
              )}

              {harvestData.fiber_yield && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">🧵</span>
                  <div>
                    <strong>Rendimiento de Fibra</strong>
                    <p>{ui.formatTaskName(harvestData.fiber_yield)}</p>
                  </div>
                </div>
              )}

              {harvestData.seed_yield && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">🌰</span>
                  <div>
                    <strong>Rendimiento de Semillas</strong>
                    <p>{ui.formatTaskName(harvestData.seed_yield)}</p>
                  </div>
                </div>
              )}

              {harvestData.uses && harvestData.uses.length > 0 && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">🔧</span>
                  <div>
                    <strong>Usos</strong>
                    <p>{harvestData.uses.map(use => ui.formatTaskName(use)).join(', ')}</p>
                  </div>
                </div>
              )}

              {harvestData.fiber_quality && (
                <div class="harvest-detail-item">
                  <span class="detail-icon">💪</span>
                  <div>
                    <strong>Calidad de Fibra</strong>
                    <p>{ui.formatTaskName(harvestData.fiber_quality)}</p>
                  </div>
                </div>
              )}
            </div>
          </section>
        )}
      </div>

      <!-- Back Navigation -->
      <div class="back-navigation">
        <a href={`/calendario/categoria/${category}/`} class="back-link">
          ← Volver a {categoryName}
        </a>
        <a href="/calendario/" class="back-link">
          Calendario Principal
        </a>
      </div>
    </div>
  </div>

  <!-- Structured Data for Plant Calendar -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": ["FAQPage", "HowTo"],
    "name": `Cómo cultivar ${plantName}: calendario de siembra y cosecha`,
    "description": `Guía paso a paso para cultivar ${plantName} con calendario detallado de siembra, trasplante y cosecha`,
    "totalTime": "PT365D",
    "estimatedCost": {
      "@type": "MonetaryAmount",
      "currency": "EUR",
      "value": "5-15"
    },
    "tool": [
      {
        "@type": "HowToTool",
        "name": `Semillas de ${plantName}`
      },
      {
        "@type": "HowToTool", 
        "name": "Tierra de cultivo"
      },
      {
        "@type": "HowToTool",
        "name": "Regadera"
      }
    ],
    "step": [
      {
        "@type": "HowToStep",
        "name": "Preparación y siembra",
        "text": `Planifica la siembra según el calendario estacional específico para ${plantName}`,
        "image": "https://plantasyflores.online/wp-content/uploads/semillas.webp"
      },
      {
        "@type": "HowToStep", 
        "name": "Trasplante",
        "text": "Trasplanta las plántulas en el momento óptimo según las condiciones climáticas",
        "image": "https://plantasyflores.online/wp-content/uploads/trasplante.webp"
      },
      {
        "@type": "HowToStep",
        "name": "Cuidados y mantenimiento", 
        "text": "Proporciona los cuidados necesarios durante el ciclo de crecimiento",
        "image": "https://plantasyflores.online/wp-content/uploads/cuidados.webp"
      },
      {
        "@type": "HowToStep",
        "name": "Cosecha",
        "text": "Cosecha en el momento óptimo para obtener la mejor calidad",
        "image": "https://plantasyflores.online/wp-content/uploads/cosecha.webp"
      }
    ],
    "mainEntity": schemaFAQ.map(faq => ({
      "@type": "Question",
      "name": faq.question,
      "acceptedAnswer": {
        "@type": "Answer",
        "text": faq.answer
      }
    })),
    "about": {
      "@type": "Thing",
      "name": plantName,
      ...(plantInfo.scientific_name ? { "scientificName": plantInfo.scientific_name } : {}),
      "category": categoryName
    },
    "author": {
      "@type": "Organization",
      "name": "Plantas y Flores",
      "url": "https://plantasyflores.online"
    },
    "datePublished": new Date().toISOString(),
    "dateModified": new Date().toISOString()
  })} />

</BaseLayout>

<style>
  .plant-calendar-view {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  }

  .intro-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #48bb78;
  }

  .intro-content p {
    color: #4a5568;
    line-height: 1.7;
    margin-bottom: 1rem;
    font-size: 1rem;
  }

  .intro-content p:last-child {
    margin-bottom: 0;
  }

  .intro-content strong {
    color: #2d3748;
    font-weight: 600;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    margin-bottom: var(--space-lg);
    font-size: var(--font-size-sm);
    opacity: 0.9;
  }

  .breadcrumb a {
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    transition: opacity 0.3s ease;
  }

  .breadcrumb a:hover {
    opacity: 0.8;
  }

  .breadcrumb .separator {
    margin: 0 var(--space-xs);
    opacity: 0.7;
  }

  .breadcrumb .current {
    opacity: 0.7;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .category-icon-small,
  .plant-icon-small {
    font-size: 1rem;
  }

  .plant-header {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    padding: 2rem 0 3rem 0;
    margin-bottom: 2rem;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    opacity: 0.9;
  }

  .breadcrumb a {
    color: white;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .breadcrumb a:hover {
    opacity: 0.8;
  }

  .breadcrumb .separator {
    margin: 0 0.75rem;
    opacity: 0.7;
  }

  .breadcrumb .current {
    opacity: 0.7;
  }

  .plant-title {
    text-align: center;
  }

  .plant-title h1 {
    font-size: 3rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
  }

  .plant-icon {
    font-size: 3rem;
  }

  .scientific-name {
    font-size: 1.2rem;
    font-style: italic;
    opacity: 0.8;
    margin-bottom: 1rem;
  }

  .plant-meta {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .plant-type, .difficulty, .origin {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .plant-type.annual { border-left: 3px solid #48bb78; }
  .plant-type.perennial { border-left: 3px solid #4299e1; }
  .plant-type.biennial { border-left: 3px solid #ed8936; }

  .difficulty.beginner { border-left: 3px solid #48bb78; }
  .difficulty.intermediate { border-left: 3px solid #ed8936; }
  .difficulty.advanced { border-left: 3px solid #f56565; }

  .main-article-btn {
    background: white;
    color: #48bb78;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .main-article-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .timeline-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .timeline-section h2 {
    color: #2d3748;
    margin-bottom: 2rem;
    font-size: 1.75rem;
    text-align: center;
  }

  .yearly-timeline {
    overflow-x: auto;
  }

  .timeline-months {
    display: grid;
    grid-template-columns: repeat(12, minmax(200px, 1fr));
    gap: 1rem;
    min-width: 1200px;
  }

  .timeline-month {
    background: #f7fafc;
    border-radius: 8px;
    padding: 1rem;
    min-height: 200px;
    transition: all 0.3s ease;
  }

  .timeline-month.has-activities {
    background: #f0fff4;
    border: 2px solid #c6f6d5;
  }

  .month-header {
    text-align: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .month-header h3 {
    margin: 0 0 0.25rem 0;
    color: #2d3748;
    font-size: 1rem;
    font-weight: 600;
  }

  .month-number {
    color: #718096;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .month-activities {
    min-height: 120px;
  }

  .activities-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .activity-item {
    background: white;
    border-radius: 4px;
    padding: 0.5rem;
    border-left: 3px solid #e2e8f0;
    font-size: 0.8rem;
    transition: all 0.3s ease;
  }

  .activity-item:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .activity-item.high {
    background: #fff5f5;
    border-left-color: #f56565;
  }

  .activity-item.medium {
    background: #fffbf0;
    border-left-color: #ed8936;
  }

  .activity-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .activity-icon {
    font-size: 0.9rem;
    width: 16px;
    text-align: center;
  }

  .activity-label {
    font-weight: 600;
    color: #2d3748;
  }

  .activity-details {
    color: #718096;
    font-size: 0.75rem;
    margin-left: 1.5rem;
  }

  .no-activities {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #a0aec0;
    font-style: italic;
    text-align: center;
  }

  .export-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
  }

  .export-wrapper h2 {
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .export-wrapper p {
    color: #718096;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
  }

  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .details-card {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .details-card h3 {
    color: #2d3748;
    margin-bottom: 1.5rem;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .conditions-grid, .harvest-info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .condition-item, .harvest-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 1rem;
    background: #f7fafc;
    border-radius: 8px;
  }

  .condition-icon, .harvest-icon {
    font-size: 1.5rem;
    width: 32px;
    text-align: center;
    flex-shrink: 0;
  }

  .condition-item strong, .harvest-item strong {
    display: block;
    color: #2d3748;
    margin-bottom: 0.25rem;
  }

  .condition-item p, .harvest-item p {
    color: #4a5568;
    margin: 0;
    font-size: 0.9rem;
  }

  .companions-section {
    margin-bottom: 1.5rem;
  }

  .companions-section:last-child {
    margin-bottom: 0;
  }

  .companions-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 1rem;
  }

  .companions-title.good {
    color: #38a169;
  }

  .companions-title.bad {
    color: #e53e3e;
  }

  .companions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .companion-tag {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .companion-tag.good {
    background: #c6f6d5;
    color: #22543d;
    border: 1px solid #9ae6b4;
  }

  .companion-tag.good.clickable:hover {
    background: #9ae6b4;
    transform: translateY(-1px);
  }

  .companion-tag.bad {
    background: #fed7d7;
    color: #742a2a;
    border: 1px solid #feb2b2;
  }

  .companion-tag.bad.clickable:hover {
    background: #feb2b2;
    transform: translateY(-1px);
  }

  .companion-tag.no-link {
    cursor: default;
    opacity: 0.7;
  }

  .no-link-indicator {
    font-size: 0.7rem;
    opacity: 0.6;
    margin-left: 0.25rem;
  }

  .companions-note {
    font-size: 0.8rem;
    color: #718096;
    margin-top: 0.5rem;
    margin-bottom: 0;
    font-style: italic;
  }

  .companion-icon {
    font-size: 1rem;
  }

  .back-navigation {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 2rem 0;
  }

  .back-link {
    background: #48bb78;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.3s ease;
  }

  .back-link:hover {
    background: #5a67d8;
  }

  @media (max-width: 768px) {
    .plant-title h1 {
      font-size: 2rem;
      flex-direction: column;
      gap: 0.5rem;
    }

    .plant-icon {
      font-size: 2rem;
    }

    .plant-meta {
      flex-direction: column;
      align-items: center;
    }

    .timeline-section {
      padding: var(--space-md);
    }
    
    .yearly-timeline {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .timeline-months {
      grid-template-columns: repeat(12, 160px);
      gap: var(--space-sm);
    }
    
    .timeline-month {
      min-height: 150px;
      padding: var(--space-sm);
    }
    
    .month-header h3 {
      font-size: 0.9rem;
    }
    
    .activity-item {
      padding: calc(var(--space-xs) * 0.75);
      font-size: 0.75rem;
    }
    
    .activity-label {
      font-size: 0.75rem;
    }
    
    .activity-details {
      font-size: 0.7rem;
      margin-left: 1rem;
    }

    .details-grid {
      grid-template-columns: 1fr;
      gap: var(--space-md);
    }
    
    .details-card {
      padding: var(--space-md);
    }

    .back-navigation {
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .back-link {
      width: 100%;
      max-width: 250px;
      text-align: center;
    }

    .breadcrumb {
      font-size: 0.8rem;
      flex-wrap: wrap;
      gap: calc(var(--space-xs) * 0.5);
    }
  }
</style>